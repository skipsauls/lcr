var force=function(){function e(e){e.appId&&(p=e.appId),e.loginUrl&&(T=e.loginUrl),e.instanceUrl&&(m=e.instanceUrl),e.accessToken&&(h={access_token:e.accessToken},h.instance_url=e.instanceURL||location.protocol+"//"+location.hostname+(location.port?":"+location.port:""),h.refresh_token=e.refreshToken),x=e.apiVersion||x,R=e.tokenStore||R,S=e.oauthRedirectURL||S,v=e.proxyURL||v,R.forceOAuth&&(h=JSON.parse(R.forceOAuth))}function t(e,t){function o(e){var t=e.url;if(t.indexOf("access_token=")>0||t.indexOf("error=")>0){_=!0;var o=700-((new Date).getTime()-i);setTimeout(function(){a.close(),n(t)},o>0?o:0)}}function r(){a.insertCSS({code:"#left_side{width:300px;} #content {width:240px;}"})}function s(){!_&&k&&k({error:"user_cancelled",error_description:"User cancelled login process",error_reason:"user_cancelled"}),a.removeEventListener("loadstart",o),a.removeEventListener("loadstop",r),a.removeEventListener("exit",s),a=null}var a,i;if(!p)throw"appId parameter not set in init()";g=e||g,k=t||k,_=!0,i=(new Date).getTime(),a=window.open(T+"/services/oauth2/authorize?client_id="+p+"&redirect_uri="+S+"&response_type=token","_blank","location=no"),O&&(a.addEventListener("loadstart",o),a.addEventListener("loadstop",r),a.addEventListener("exit",s))}function n(e){var t,n;e.indexOf("access_token=")>0?(t=e.substr(e.indexOf("#")+1),n=u(t),n.instanceUrl=m||n.instance_url,h=n,R.forceOAuth=JSON.stringify(h),g&&g()):e.indexOf("error=")>0?(t=decodeURIComponent(e.substring(e.indexOf("?")+1)),n=u(t),k&&k(n)):k&&k({status:"access_denied"})}function o(){return h&&h.access_token?!0:!1}function r(e,t,n){if(!h||!h.access_token&&!h.refresh_token)return void(n&&n("No access token. Login and try again."));var o=e.method||"GET",a=new XMLHttpRequest,i=v?v:h.instance_url;"/"===i.slice(-1)&&(i=i.slice(0,-1)),"/"!==e.path.charAt(0)&&(e.path="/"+e.path),i+=e.path,e.params&&(i+="?"+d(e.params)),a.onreadystatechange=function(){if(4===a.readyState)if(a.status>199&&a.status<300)t&&t(a.responseText?JSON.parse(a.responseText):void 0);else if(401===a.status)s(function(){r(e,t,n)},function(){console.error(a.responseText);var e=a.responseText?JSON.parse(a.responseText):{message:"An error has occurred"};e&&e(e)});else{console.error(a.responseText);var o=a.responseText?JSON.parse(a.responseText):{message:"An error has occurred"};n&&n(o)}},a.open(o,i,!0),a.setRequestHeader("Accept","application/json"),a.setRequestHeader("Authorization","Bearer "+h.access_token),e.contentType&&a.setRequestHeader("Content-Type",e.contentType),v&&a.setRequestHeader("Target-URL",h.instance_url),a.send(e.data?JSON.stringify(e.data):void 0)}function s(e,t){var n=cordova.require("com.salesforce.plugin.oauth");n?a(n,e,t):i(e,t)}function a(e,t,n){e.authenticate(function(e){h.access_token=e.accessToken,R.forceOAuth=JSON.stringify(h),t&&t()},function(){console.error("Error refreshing oauth access token using the oauth plugin"),n&&n()})}function i(e,t){if(!h.refresh_token)return console.error("ERROR: refresh token does not exist"),void(t&&t());var n=new XMLHttpRequest,o={grant_type:"refresh_token",refresh_token:h.refresh_token,client_id:p},r=v?v:T;r=r+"/services/oauth2/token?"+d(o),n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){console.log("Token refreshed");var o=JSON.parse(n.responseText);h.access_token=o.access_token,R.forceOAuth=JSON.stringify(h),e&&e()}else console.log("Error while trying to refresh token"),console.log(n.responseText),t&&t()},n.open("POST",r,!0),v&&n.setRequestHeader("Target-URL",T),n.send()}function c(){delete h.access_token,R.forceOAuth=JSON.stringify(h)}function u(e){var t=decodeURIComponent(e),n={},o=t.split("&");return o.forEach(function(e){var t=e.split("=");n[t[0]]=t[1]}),n}function d(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}function l(){h.access_token=void 0}function f(){return h}var p,h,v,g,k,_,O,T="https://login.salesforce.com",m=null,x="v30.0",R={},y=window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/")),L=location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+y,S=L+"/oauthcallback";return document.addEventListener("deviceready",function(){O=!0},!1),{init:e,login:t,isLoggedIn:o,request:r,discardToken:c,oauthCallback:n,invalidateToken:l,getOauth:f}}();